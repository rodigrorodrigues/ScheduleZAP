<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>ScheduleZAP - Agendador de Mensagens WhatsApp</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="ScheduleZAP" />
    <meta name="msapplication-TileColor" content="#667eea" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />

    <!-- Icons - Removido para evitar erros -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .sidebar {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border-radius: 10px;
        margin: 5px 0;
        transition: all 0.3s;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: white;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }
      .main-content {
        background: #f8f9fa;
        min-height: 100vh;
      }

      /* Mobile Responsiveness */
      @media (max-width: 768px) {
        .sidebar {
          min-height: auto;
          position: fixed;
          top: 0;
          left: -100%;
          width: 280px;
          z-index: 1050;
          transition: left 0.3s ease;
        }
        .sidebar.show {
          left: 0;
        }
        .main-content {
          margin-left: 0;
          padding: 1rem;
        }
        .mobile-menu-toggle {
          display: block;
          position: fixed;
          top: 1rem;
          left: 1rem;
          z-index: 1060;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          color: white;
          padding: 0.5rem;
          border-radius: 50%;
          width: 50px;
          height: 50px;
        }
        .mobile-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1040;
        }
        .mobile-overlay.show {
          display: block;
        }
        .card {
          margin-bottom: 1rem;
        }
        .form-control,
        .btn {
          font-size: 16px; /* Previne zoom no iOS */
        }
      }
      @media (min-width: 769px) {
        .mobile-menu-toggle {
          display: none;
        }
      }
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
      }
      .card:hover {
        transform: translateY(-5px);
      }
      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
      }
      .btn-danger {
        border-radius: 10px;
      }
      .form-control,
      .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
      }
      .form-control:focus,
      .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
      }
      .status-badge {
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.8rem;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-sent {
        background: #d4edda;
        color: #155724;
      }
      .status-error {
        background: #f8d7da;
        color: #721c24;
      }

      /* Estilos para o seletor de conversas */
      .chat-item {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .chat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .chat-item .card-body {
        border-radius: 10px;
      }

      #chatSearchInput {
        border-radius: 10px;
      }

      .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
      }

      .modal-header .btn-close {
        filter: invert(1);
      }

      /* Garantir que o botão de seleção de conversa seja visível */
      .input-group .btn {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
    </style>
  </head>
  <body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-3">
          <div class="text-center mb-4">
            <h4 class="text-white">
              <i class="fab fa-whatsapp me-2"></i>
              ScheduleZAP
            </h4>
            <small class="text-white-50" id="userInfo">Carregando...</small>
          </div>
          <nav class="nav flex-column">
            <a
              class="nav-link active"
              href="#"
              onclick="showSection('schedule')"
            >
              <i class="fas fa-calendar-plus me-2"></i>
              Agendar
            </a>
            <a class="nav-link" href="#" onclick="showSection('scheduled')">
              <i class="fas fa-list me-2"></i>
              Mensagens Agendadas
            </a>
            <a
              class="nav-link d-none"
              id="adminNav"
              href="#"
              onclick="showSection('admin')"
            >
              <i class="fas fa-user-shield me-2"></i>
              Admin
            </a>
            <hr class="text-white-50" />
            <a class="nav-link text-danger" href="#" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2"></i>
              Sair
            </a>
          </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 main-content p-4">
          <!-- Seção Agendar -->
          <div id="schedule-section" class="section">
            <div class="row">
              <div class="col-12">
                <h2 class="mb-4">
                  <i class="fas fa-calendar-plus text-primary me-2"></i>
                  Agendar Nova Mensagem
                </h2>
              </div>
            </div>
            <div class="row">
              <div class="col-lg-8">
                <div class="card">
                  <div class="card-body">
                    <form id="scheduleForm">
                      <div class="row">
                        <div class="col-md-6 mb-3">
                          <label for="phone" class="form-label"
                            >Destino (contato ou grupo)</label
                          >
                          <div class="input-group">
                            <input
                              type="text"
                              class="form-control"
                              id="phone"
                              placeholder="5511999999999"
                              required
                            />
                            <button
                              class="btn btn-outline-secondary"
                              type="button"
                              onclick="openChatSelector()"
                              title="Selecionar grupo"
                            >
                              <i class="fas fa-users me-1"></i>
                              Grupos
                            </button>
                          </div>
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="scheduledTime" class="form-label"
                            >Data e Hora</label
                          >
                          <input
                            type="datetime-local"
                            class="form-control"
                            id="scheduledTime"
                            required
                          />
                        </div>
                      </div>
                      <div class="mb-3">
                        <label for="message" class="form-label">Mensagem</label>
                        <textarea
                          class="form-control"
                          id="message"
                          rows="5"
                          placeholder="Digite sua mensagem aqui..."
                          required
                        ></textarea>
                      </div>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>
                        Agendar Mensagem
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Seção Mensagens Agendadas -->
          <div id="scheduled-section" class="section" style="display: none">
            <div class="row">
              <div class="col-12">
                <div
                  class="d-flex justify-content-between align-items-center mb-4"
                >
                  <h2>
                    <i class="fas fa-list text-primary me-2"></i>
                    Mensagens Agendadas
                  </h2>
                  <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="refreshMessages()"
                  >
                    <i class="fas fa-sync-alt me-1"></i>
                    Atualizar
                  </button>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <div id="messagesList">
                      <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Carregando mensagens...</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Seção Admin -->
          <div id="admin-section" class="section" style="display: none">
            <div class="row">
              <div
                class="col-12 d-flex justify-content-between align-items-center mb-3"
              >
                <h2>
                  <i class="fas fa-user-shield text-primary me-2"></i>
                  Administração
                </h2>
                <div>
                  <button
                    class="btn btn-success me-2"
                    onclick="openCreateUserModal()"
                  >
                    <i class="fas fa-plus me-1"></i>
                    Novo Usuário
                  </button>
                  <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="loadUsers()"
                  >
                    <i class="fas fa-sync-alt me-1"></i>
                    Atualizar
                  </button>
                </div>
              </div>
            </div>

            <!-- Estatísticas -->
            <div class="row mb-4">
              <div class="col-md-3">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <h4 id="totalUsers">-</h4>
                    <small>Total de Usuários</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-success text-white">
                  <div class="card-body text-center">
                    <h4 id="activeUsers">-</h4>
                    <small>Usuários Ativos</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-warning text-white">
                  <div class="card-body text-center">
                    <h4 id="adminUsers">-</h4>
                    <small>Administradores</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-info text-white">
                  <div class="card-body text-center">
                    <h4 id="totalMessages">-</h4>
                    <small>Mensagens Agendadas</small>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">
                      <i class="fas fa-users-cog me-2"></i> Gerenciar Usuários
                    </h5>
                  </div>
                  <div class="card-body">
                    <div id="usersList">
                      <div class="text-center text-muted p-3">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <p>
                          Clique em "Atualizar" para carregar a lista de
                          usuários
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast para notificações -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="toast" class="toast" role="alert">
        <div class="toast-header">
          <strong class="me-auto">ScheduleZAP</strong>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
          ></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
      </div>
    </div>

    <!-- Modal para seleção de conversas -->
    <div
      class="modal fade"
      id="chatSelectorModal"
      tabindex="-1"
      aria-labelledby="chatSelectorModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="chatSelectorModalLabel">
              <i class="fas fa-users me-2"></i>
              Selecionar Grupo
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <div class="input-group">
                <input
                  type="text"
                  class="form-control"
                  id="chatSearchInput"
                  placeholder="Buscar grupos..."
                  onkeyup="filterChats()"
                />
                <button
                  class="btn btn-outline-primary"
                  type="button"
                  onclick="reloadGroups()"
                >
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>

              <!-- Filtros removidos: manter apenas busca por texto -->
            </div>
            <div id="chatsList">
              <div class="text-center text-muted">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Carregando conversas...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para criação de usuários -->
    <div
      class="modal fade"
      id="createUserModal"
      tabindex="-1"
      aria-labelledby="createUserModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="createUserModalLabel">
              <i class="fas fa-user-plus me-2"></i>
              Criar Novo Usuário
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="createUserForm">
              <div class="mb-3">
                <label for="modalUsername" class="form-label"
                  >Nome de Usuário</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="modalUsername"
                  placeholder="Digite o nome de usuário"
                  required
                  minlength="3"
                />
                <div class="form-text">Mínimo 3 caracteres</div>
              </div>
              <div class="mb-3">
                <label for="modalPassword" class="form-label"
                  >Senha Inicial</label
                >
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="modalPassword"
                    placeholder="Senha temporária"
                    required
                    minlength="6"
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    onclick="generateRandomPassword()"
                  >
                    <i class="fas fa-dice"></i>
                  </button>
                </div>
                <div class="form-text">
                  Mínimo 6 caracteres. O usuário deverá alterar no primeiro
                  login.
                </div>
              </div>
              <div class="mb-3">
                <label for="modalRole" class="form-label"
                  >Tipo de Usuário</label
                >
                <select id="modalRole" class="form-select">
                  <option value="user" selected>Usuário</option>
                  <option value="admin">Administrador</option>
                </select>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="forcePasswordChange"
                    checked
                  />
                  <label class="form-check-label" for="forcePasswordChange">
                    Forçar alteração de senha no primeiro login
                  </label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="createUserFromModal()"
            >
              <i class="fas fa-save me-1"></i>
              Criar Usuário
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para configurações de usuário -->
    <div
      class="modal fade"
      id="userConfigModal"
      tabindex="-1"
      aria-labelledby="userConfigModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userConfigModalLabel">
              <i class="fas fa-cog me-2"></i>
              Configurações do Usuário
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  Configure as credenciais da Evolution API para o usuário
                  <strong id="configUserName"></strong>
                </div>
              </div>
            </div>
            <form id="userConfigForm">
              <input type="hidden" id="configUserId" />
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="configApiUrl" class="form-label"
                    >Evolution API URL</label
                  >
                  <input
                    type="url"
                    class="form-control"
                    id="configApiUrl"
                    placeholder="http://localhost:8080"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="configInstance" class="form-label"
                    >Nome da Instância</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="configInstance"
                    placeholder="default"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="configToken" class="form-label">API Key</label>
                <div class="input-group">
                  <input
                    type="password"
                    class="form-control"
                    id="configToken"
                    placeholder="Sua API Key"
                    required
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    onclick="togglePasswordVisibility('configToken')"
                  >
                    <i class="fas fa-eye" id="configTokenIcon"></i>
                  </button>
                </div>
              </div>
              <div class="mb-3">
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  onclick="testUserConnection()"
                >
                  <i class="fas fa-wifi me-1"></i>
                  Testar Conexão
                </button>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveUserConfigFromModal()"
            >
              <i class="fas fa-save me-1"></i>
              Salvar Configuração
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>
  </body>
</html>
